







<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Example | docs</title>
    <link rel="shortcut icon" href="_static/favicon.ico">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="_static/theme.css" type="text/css">
    
      
    <link rel="stylesheet" type="text/css" href="_static/css/miros_docs.css" />
      
    
    

    
    <script type="text/javascript" src="_static/theme.js" defer></script>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    
    <script src="_static/jquery.js"></script>
    
    <script src="_static/underscore.js"></script>
    
    <script src="_static/doctools.js"></script>
    
    <script src="_static/language_data.js"></script>
    
    

    
      
      
    <link rel="index" title="Index" href="genindex.html">
      
      
    <link rel="search" title="Search" href="search.html">
      
      
      
    <link rel="next" title="Recipes" href="recipes.html">
      
      
    <link rel="prev" title="How it Works" href="how_it_works.html">
      
    

    

    

    
  </head>

  <body>
    <header class="main-header">
      <div class="navbar">
        <div id="js-sidebar-mask" class="sidebar-mask"></div>
        <div id="js-sidebar-menu-button" class="sidebar-menu-button">
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg>
        </div>
        <a href="index.html" class="site-link">
          
          miros rabbit-mq
          
        </a>
        <div class="navbar-links">
          <a href="introduction.html" class="navbar-link">Docs</a>
          
          <a href="https://github.com/aleph2c/miros-rabbitmq" class="navbar-link">GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
          
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      
      <div id="js-main-sidebar" class="main-sidebar">
        
        <div class="sidebar-content sidebar-content--divider sidebar-navbar-links">
          <a href="https://github.com/aleph2c/miros-rabbitmq" class="sidebar-navbar-link">GitHub</a>
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
        </div>
        
        
        <div class="sidebar-content sidebar-logo">
    <a href="index.html">
      <img class="logo" src="_static/miros_rabbitmq_logo_v2.svg" alt="miros" >
    </a>
</div>
        
        

<h2 class="sidebar-heading">Contents</h2>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing_infrastructure.html">DevOps</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="how_it_works.html">How it Works</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="reflection.html">Reflection</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs.html">Documenting</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
</ul>

        
        <h3 class="sidebar-heading">About</h3>
<p class="sidebar-content">
  A networking plugin for miros
</p>
<h3 class="sidebar-heading">Useful Links</h3>
<ul>
  <li><a href="https://github.com/aleph2c/miros-rabbitmq">miros-rabbitmq on Github</a></li>
  <li><a href="https://aleph2c.github.io/miros/html">miros</a></li>
  <li><a href="https://github.com/aleph2c/miros">miros on Github</a></li>
  <li><a href="https://github.com/aleph2c/sequence">sequence on Github</a></li>
  <li><a href="http://www.umlet.com">UMLet (drawing tool)</a></li>
</ul>

<h3 class="sidebar-heading">Tutorials</h3>
<ul>
  <li><a href="https://www.rabbitmq.com/tutorials/tutorial-one-python.html">basics</a></li>
  <li><a href="https://www.rabbitmq.com/tutorials/tutorial-two-python.html">work queues</a></li>
  <li><a href="https://www.rabbitmq.com/tutorials/tutorial-three-python.html">publish subscribe</a></li>
  <li><a href="https://www.rabbitmq.com/tutorials/tutorial-four-python.html">routing</a></li>
  <li><a href="https://www.rabbitmq.com/tutorials/tutorial-five-python.html">topics</a></li>
  <li><a href="https://www.rabbitmq.com/tutorials/tutorial-six-python.html">remote procedure calls (rpc)</a></li>
</ul>

<h3 class="sidebar-heading">Videos</h3>
<ul>
  <li><a href="https://www.youtube.com/watch?v=deG25y_r6OY">RabbitMQ in Five Minutes</a></li>
  <li><a href="https://www.youtube.com/watch?v=gKzKUmtOwR4">RabbitMQ Windows Install</a></li>
</ul>
        
        

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel" class="sidebar-heading">Quick search</h2>
  <div class="searchformwrapper sidebar-content">
    <form class="search" action="search.html" method="get">
      <input class="sidebar-search sidebar-search--input" type="text" name="q" aria-labelledby="searchlabel"><input class="sidebar-search sidebar-search--btn" type="submit" value="Go">
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

        
      </div>
      

      
      <div class="main-content main-content--sidebar">
      
        
          
  <div class="section" id="example">
<span id="id1"></span><h1>Example<a class="headerlink" href="#example" title="Permalink to this headline">#</a></h1>
<blockquote class="epigraph">
<div><p><em>You can analyse the past, but you need to design the future.  That is the
difference between suffering the future and enjoying it.</em></p>
<p class="attribution">—Edward de Bono</p>
</div></blockquote>
<div class="toctree-wrapper compound">
</div>
<p>In this section I will show how to network some statecharts using the
miros-rabbitmq plugin.  Here is a diagram that throws all of this example’s
ideas at you at once:</p>
<a class="reference external image-reference" href="_static/test_miros_rabbitmq_2.pdf"><img alt="_images/test_miros_rabbitmq_2.svg" class="scale-to-fit" src="_images/test_miros_rabbitmq_2.svg" /></a>
<p>The diagram above illustrates:</p>
<ul class="simple">
<li><p>How you can link a NetworkedActiveObject or a NetworkedFactory to a statechart.</p></li>
<li><p>How these networked classes are just generalizations of the miros classes.</p></li>
<li><p>How they have a standard interface, so they can share the same networking API.</p></li>
<li><p>That they both contain a MirosNets object that does the lion’s share of the
networking for them.</p></li>
</ul>
<p>In this example, I’ll create two different objects which implement the
statechart in the diagram. One will use the NetworkedActiveObject class, and the
other will use the NetworkedFactory class.</p>
<p>The pictured statechart is a simple ergotic design that can work on its own or
with one or more statecharts just like it.  If there is more than one of these
statecharts working together, they can run on the same computer in different
processes or on different computers across a network.</p>
<p>The statechart can send events to itself and others.  To avoid any confusion
about where events are coming from we follow a simple coding convention: any
event that is alien to the statechart will have the word ‘other’ pre-pended
to it’s signal name.</p>
<p>Before you begin the example <a class="reference internal" href="installing_infrastructure.html#installing-infrastructure-installing-required-programs"><span class="std std-ref">get your RabbitMQ installation
working</span></a> , then install
the miros and the miros-rabbitmq packages using pip.</p>
<p>The example will be broken down into three parts:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#example-networkedactiveobjectwithdetails"><span class="std std-ref">Build a NetworkedActiveObject with Details</span></a></p></li>
<li><p><a class="reference internal" href="#example-build-a-networkedactiveobject"><span class="std std-ref">Build a NetworkedActiveObject</span></a></p></li>
<li><p><a class="reference internal" href="#example-networkedfactory"><span class="std std-ref">Build a NetworkedFactory</span></a></p></li>
</ul>
<div class="section" id="build-a-networkedactiveobject-with-details">
<span id="example-networkedactiveobjectwithdetails"></span><h2>Build a NetworkedActiveObject with Details<a class="headerlink" href="#build-a-networkedactiveobject-with-details" title="Permalink to this headline">#</a></h2>
<p>This example will describe a few network details, and some of the mechanisms
under the hood.  If you would rather just look at an example without such
detail, look <a class="reference internal" href="#example-build-a-networkedactiveobject"><span class="std std-ref">here</span></a>.</p>
<p>To build the NetworkedActiveObject we import the required libraries:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span> <span class="c1"># to generate a unique name</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros_rabbitmq</span> <span class="kn">import</span> <span class="n">NetworkedActiveObject</span>
</pre></div>
</div>
<p>Then we construct a function that will generate a unique name for our
statechart:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_name</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">post</span>
</pre></div>
</div>
<p>Now we consider the statechart part of our design:</p>
<a class="reference external image-reference" href="_static/miros_rabbitmq_example_1.pdf"><img alt="_images/miros_rabbitmq_example_1.svg" class="scale-to-fit" src="_images/miros_rabbitmq_example_1.svg" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">outer_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_outer</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">outer_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">outer_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">inner_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="hll">  <span class="n">chart</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span>  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">inner_other_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">other_to_outer</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_other_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">):</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>I have highlighted the <cite>other</cite> event signals in the code listing.  This is to
demonstrate how the statechart will react to such events when they have been
received from another statechart, and how to transmit them out to others.</p>
<p>The <cite>other</cite> event signals received from another statechart are placed in the
FIFO of the active object by the miros-rabbitmq library.  As far as the event
processor is concerned, they are no different than any native event; the only
way that we know they are alien is that we have pre-pended the word ‘other’ to
them, as a coding convention.</p>
<p>To send a message out to another statechart, you use the <code class="docutils literal notranslate"><span class="pre">transmit</span></code> api
provided by the NetworkedActiveObject.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be careful where you place your transmit calls in your statecharts, since it is
easy to create an event oscillation between your networked charts.  I tend to
send out <cite>other</cite> events to the network when a state has been initialized, or
entered (when in the inner most state).</p>
</div>
<a class="reference external image-reference" href="_static/miros_rabbitmq_example_2.pdf"><img alt="_images/miros_rabbitmq_example_2.svg" class="scale-to-fit" src="_images/miros_rabbitmq_example_2.svg" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember that ActiveObjects and thereby NetworkedActiveObjects are
<a class="reference external" href="https://aleph2c.github.io/miros/recipes.html#what-a-state-does-and-how-to-structure-it">polyamourous</a>.
The same statechart structure can be used by many different
NetworkedActiveObject’s since they hold no state about themselves; they merely
act as a blueprint of behavior.  All of the state information is held within the
NetworkedActiveObject.</p>
</div>
<p>Now that we have a statechart we need to link it to a NetworkedActiveObject.
But before we do that, we need to build the NetworkedActiveObject using:</p>
<ul class="simple">
<li><p>the networking credentials we have set up for our RabbitMQ server</p></li>
<li><p>a tx_routing key</p></li>
<li><p>a rx_routing key</p></li>
<li><p>the encryption keys that will be used by the other programs in our network.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span> <span class="o">=</span> <span class="n">NetworkedActiveObject</span><span class="p">(</span><span class="s1">&#39;make_name(&#39;</span><span class="n">ao</span><span class="s1">&#39;),</span>
  <span class="n">rabbit_user</span><span class="o">=</span><span class="s1">&#39;peter&#39;</span><span class="p">,</span>
  <span class="n">rabbit_password</span><span class="o">=</span><span class="s1">&#39;rabbit&#39;</span><span class="p">,</span>
  <span class="n">tx_routing_key</span><span class="o">=</span><span class="s1">&#39;heya.man&#39;</span><span class="p">,</span>
  <span class="n">rx_routing_key</span><span class="o">=</span><span class="s1">&#39;#.man&#39;</span><span class="p">,</span>
  <span class="n">mesh_encryption_key</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;u3Uc-qAi9iiCv3fkBfRUAKrM1gH8w51-nVU8M8A73Jg=&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We name our <code class="docutils literal notranslate"><span class="pre">ao</span></code> object using the <code class="docutils literal notranslate"><span class="pre">make_name</span></code> function that we built at the top of the
example, it pre-pends 5 digits of a UUID to the front of <code class="docutils literal notranslate"><span class="pre">_ao</span></code>.
The rabbit_user and rabbit_password, networking credentials are specified when you <a class="reference external" href="installing_infrastructure-installing-required-programs">install your RabbitMQ server</a>.  The topic
tx_routing_key are used by the RabbitMQ exchanges to publish to different
queues.  A consumer can subscribe to different topics <a class="reference external" href="https://www.rabbitmq.com/tutorials/tutorial-five-python.html">using a simple pattern
matching technique</a>
specified with its rx_routing_key.  In our case our program will receive any
network message from exchanges with the last word of ‘man’ in their topic.</p>
<p>RabbitMQ supports SSL, but this library doesn’t get involved in that.  If you
would like to install SSL, you can, and if it is working this library will
happily sit on top of it and not know that it is transmitting through a secure
connection.  This library does, however, have its own encryption layer for each
of its networks.  It uses symmetric encryption, so that the same key can be used to
encrypt and decrypt an object.</p>
<p>I am about to talk about some of the miros-rabbitmq package details, but you
don’t need to know this stuff to make your example work.  So if you want to just
skip over this information and get back to the example click <a class="reference internal" href="#back-to-the-example"><span class="std std-ref">here</span></a>.</p>
<p>Let’s look at the networks that are turned on with the miros-rabbitmq library
(click to open it as a pdf):</p>
<a class="reference external image-reference" href="_static/miros_rabbitmq_network_1.pdf"><img alt="_images/miros_rabbitmq_network_1.svg" class="scale-to-fit" src="_images/miros_rabbitmq_network_1.svg" /></a>
<p>The miros-rabbitmq package constructs the following:</p>
<ul class="simple">
<li><p>mesh network - used to transmit and receive messages between statecharts</p></li>
<li><p>snoop_trace network - to debug your entire network using <a class="reference external" href="https://aleph2c.github.io/miros/recipes.html#using-the-trace">trace</a> instrumentation</p></li>
<li><p>snoop_spy network - to debug the entire network using the <a class="reference external" href="https://aleph2c.github.io/miros/recipes.html#using-the-spy">spy</a></p></li>
</ul>
<p>When you turn on your NetworkedActiveObject, it will scan your LAN looking for
other machines that have the same rabbit credentials that you are using, then it
will create a producer for each of them in each of the networks, so you don’t
have to worry about feeding it IP addresses, it will find them if they are
connected in the same TCP/IP network.</p>
<p>Each of the networks can have their own encryption key, but if you only specify
the <code class="docutils literal notranslate"><span class="pre">mesh_encryption_key</span></code> in the NetworkedActiveObject constructor it will be
used by all of the networks.  The snoop_trace and snoop_spy encryption handles
for the NetworkedActiveObject constructor, are <code class="docutils literal notranslate"><span class="pre">snoop_trace_encryption_key</span></code> and
<code class="docutils literal notranslate"><span class="pre">snoop_spy_encryption_key</span></code>.</p>
<p>To build an encryption key for your distributed system:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="n">new_encryption_key</span> <span class="o">=</span> <span class="n">Fernet</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
</pre></div>
</div>
<p>As an application developer you just need to know what goes in, and what comes
out of each of the miros-rabbitmq networks.  This will be talked about in the
next three paragraphs.</p>
<p>The mesh network is fed an item using it’s <code class="docutils literal notranslate"><span class="pre">transmit</span></code> method.  This
information will pop out on every connected machine with the same credentials,
posted into the fifo of another connected NetworkedActiveObject or
NetworkedFactory object as if that local machine posted that event to itself as
<a class="reference external" href="https://aleph2c.github.io/miros/recipes.html#posting-an-event-to-the-fifo">post_fifo</a>.</p>
<p>The snoop_trace network will consist of nodes that have turned on this trace
information using the <code class="docutils literal notranslate"><span class="pre">enable_snoop_trace</span></code> call.  If all of the nodes in your
distributed system have turned on their snoop_trace, the snoop_trace network
will have as many nodes as the mesh network.  Information is automatically fed
into the trace network, without any work required by the application developer.
When the snoop_trace is enabled, a NetworkedActiveObject or NetworkedFactory
will turn on it’s <a class="reference external" href="https://aleph2c.github.io/miros/recipes.html#tracing-live">live trace feature</a> and feed this
string into the snoop_trace network behind the scenes.  By default, the
enable_snoop_trace call will turn on an <code class="docutils literal notranslate"><span class="pre">on_network_trace_message</span></code> callback
which will color the messages using ANSI strings and print them to your screen.
If you need to log this information, use <code class="docutils literal notranslate"><span class="pre">enable_snoop_trace_no_color</span></code> to turn
on that node’s participation in the snoop_trace network.</p>
<p>The snoop_spy network will output all of the spy information for all of the
nodes that have made an <code class="docutils literal notranslate"><span class="pre">enable_snoop_spy</span></code> call.  This amount of information
quickly becomes daunting unless you write this information into a log file then
filter it using grep.  If you are logging the information, you can use
<code class="docutils literal notranslate"><span class="pre">enable_snoop_spy_no_color</span></code> and the ANSI color codes will not pollute your log
file.  After the snoop_spy network is enabled, the miros-rabbitmq package turns
on that node’s <a class="reference external" href="https://aleph2c.github.io/miros/recipes.html#spying-live">live spy feature</a>.  All of the
snoop_spy information coming back from the network will be displayed to the
terminal.</p>
<p id="back-to-the-example">Getting back to our example: so far, we have a state chart, we have a networked
active object and we know how to generate our own encryption key(s).  Now let’s
turn on this statechart’s contribution to the distributed system’s
instrumentation, and link it to the network:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span><span class="o">.</span><span class="n">enable_snoop_trace</span><span class="p">()</span>  <span class="c1"># we want to produce and receive trace information</span>
<span class="n">ao</span><span class="o">.</span><span class="n">enable_snoop_snoop</span><span class="p">()</span>  <span class="c1"># we want to produce and receive spy information</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>  <span class="c1"># networks turned on</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>      <span class="c1"># 60 seconds of statechart interactions</span>
</pre></div>
</div>
<p>Let’s run this program on it’s own and see what it does:</p>
<div class="video-content">
    <iframe src="https://www.youtube.com/embed/nwyL9eTsBSU" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><p>So the statechart is running there are no interactions with other statecharts
because we only see our own name, in blue, and no events with the word ‘other’
prepended to their signal name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">START</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">08</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">36.593144</span><span class="p">]</span> <span class="p">[</span><span class="mi">0</span><span class="n">ca32_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">08</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">40.594301</span><span class="p">]</span> <span class="p">[</span><span class="mi">0</span><span class="n">ca32_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">to_inner</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">to_outer</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">08</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">47.598616</span><span class="p">]</span> <span class="p">[</span><span class="mi">0</span><span class="n">ca32_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_outer</span><span class="p">()</span> <span class="n">inner</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">to_inner</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">08</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">51.601238</span><span class="p">]</span> <span class="p">[</span><span class="mi">0</span><span class="n">ca32_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">08</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mf">53.603454</span><span class="p">]</span> <span class="p">[</span><span class="mi">0</span><span class="n">ca32_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_outer</span><span class="p">()</span> <span class="n">inner</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">to_outer</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">s</span><span class="p">]</span> <span class="mi">0</span><span class="n">ca32_ao</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Now let’s turn on two of these statecharts with in the same machine.  I’ll do
this using TMUX, running in the WLS:</p>
<div class="video-content">
   <iframe src="https://www.youtube.com/embed/U_F5icOP87w" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><p>The blue highlighted names are different in each of the launch instances.  The
blue represents the name of that instance and the purple is the name or names of
any other node that is interacting with the instance.</p>
<p>We see that even with two simple statecharts, the snoop_spy network is spamming
us with way too much information, so let’s turn it off.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span><span class="o">.</span><span class="n">enable_snoop_trace</span><span class="p">()</span>    <span class="c1"># we want to produce and receive trace information</span>
<span class="hll"><span class="c1"># ao.enable_snoop_snoop()  # turn off the snoop_spy network</span>
</span><span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>  <span class="c1"># networks turned on</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>      <span class="c1"># 60 seconds of statechart interactions</span>
</pre></div>
</div>
<div class="video-content">
    <iframe src="https://www.youtube.com/embed/U_F5icOP87w" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><p>Now I’ll log into another computer in the same network.  I’ll run one instance
of the program on that computer and one program locally:</p>
<div class="video-content">
   <iframe src="https://www.youtube.com/embed/MI8Sym3rCO0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><p>We see that there is a delay, then the programs begin to run.</p>
<p>It is the network discovery process that causes the delay.  When either one of
these programs turns on, they look at their computers network attributes and
determine what it’s network broadcast address is.  They then ping this broadcast
address in the hopes that other computers on the LAN will respond.  This
response will fill the machine’s ARP table.  The program then uses all of the
addresses in this ARP table to build a list of candidate AMPQ_URLS that it can
feed to its local RabbitMQ server.  It sends out a request to each of the
addresses on the list and removes any address that times out.  The remaining
addresses are used by the distributed system as peers.</p>
<p>Now to quickly document our trace; we could turn it into a sequence diagram.
With the sequence diagram and the statechart we can quickly describe the
dynamics of our distributed system.  Consider the trace from running this
program:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">29.177773</span><span class="p">]</span> <span class="p">[</span><span class="mo">04</span><span class="n">ccc_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">28.954560</span><span class="p">]</span> <span class="p">[</span><span class="mi">2771</span><span class="n">f_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">start_at</span><span class="p">()</span> <span class="n">top</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">34.178157</span><span class="p">]</span> <span class="p">[</span><span class="mo">04</span><span class="n">ccc_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">34.256485</span><span class="p">]</span> <span class="p">[</span><span class="mi">2771</span><span class="n">f_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">other_to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">37.178813</span><span class="p">]</span> <span class="p">[</span><span class="mo">04</span><span class="n">ccc_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_outer</span><span class="p">()</span> <span class="n">inner</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">37.182660</span><span class="p">]</span> <span class="p">[</span><span class="mi">2771</span><span class="n">f_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">other_to_outer</span><span class="p">()</span> <span class="n">inner</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">39.180004</span><span class="p">]</span> <span class="p">[</span><span class="mo">04</span><span class="n">ccc_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">39.191635</span><span class="p">]</span> <span class="p">[</span><span class="mi">2771</span><span class="n">f_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">44.181613</span><span class="p">]</span> <span class="p">[</span><span class="mo">04</span><span class="n">ccc_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_outer</span><span class="p">()</span> <span class="n">inner</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">44.257442</span><span class="p">]</span> <span class="p">[</span><span class="mi">2771</span><span class="n">f_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">other_to_outer</span><span class="p">()</span> <span class="n">inner</span><span class="o">-&gt;</span><span class="n">outer</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">49.183205</span><span class="p">]</span> <span class="p">[</span><span class="mo">04</span><span class="n">ccc_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
<span class="p">[</span><span class="o">+</span><span class="n">t</span><span class="p">]</span> <span class="p">[</span><span class="mi">2018</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mo">04</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mf">49.233582</span><span class="p">]</span> <span class="p">[</span><span class="mi">2771</span><span class="n">f_ao</span><span class="p">]</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">other_to_inner</span><span class="p">()</span> <span class="n">outer</span><span class="o">-&gt;</span><span class="n">inner</span>
</pre></div>
</div>
<p>In the following video I feed the trace into the sequence tool:</p>
<div class="video-content">
  <iframe src="https://www.youtube.com/embed/GQRh5Bd91O8" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
</div><p>You can see that I spent a of of time writing numbers into the diagram.  This is
because the sequence tool has no way to understand your trace; you understand
your system better than it does, so you need write in the numbers to describe
when things happen, or if they happen together.</p>
<p>The result is something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Statechart</span><span class="p">:</span> <span class="mo">04</span><span class="n">ccc_ao</span><span class="p">]</span> <span class="p">(</span><span class="n">A</span><span class="p">)</span>
      <span class="n">top</span>           <span class="n">outer</span>          <span class="n">inner</span>
       <span class="o">+--</span><span class="n">start_at</span><span class="p">()</span><span class="o">-&gt;|</span>              <span class="o">|</span>
       <span class="o">|</span>     <span class="p">(</span><span class="mi">1</span><span class="p">)</span>      <span class="o">|</span>              <span class="o">|</span>
       <span class="o">|</span>              <span class="o">+--</span><span class="n">to_inner</span><span class="p">()</span><span class="o">-&gt;|</span>
       <span class="o">|</span>              <span class="o">|</span>     <span class="p">(</span><span class="mi">3</span><span class="p">)</span>      <span class="o">|</span>
       <span class="o">|</span>              <span class="o">+&lt;-</span><span class="n">to_outer</span><span class="p">()</span><span class="o">--|</span>
       <span class="o">|</span>              <span class="o">|</span>     <span class="p">(</span><span class="mi">5</span><span class="p">)</span>      <span class="o">|</span>
       <span class="o">|</span>              <span class="o">+--</span><span class="n">to_inner</span><span class="p">()</span><span class="o">-&gt;|</span>
       <span class="o">|</span>              <span class="o">|</span>     <span class="p">(</span><span class="mi">7</span><span class="p">)</span>      <span class="o">|</span>
       <span class="o">|</span>              <span class="o">+&lt;-</span><span class="n">to_outer</span><span class="p">()</span><span class="o">--|</span>
       <span class="o">|</span>              <span class="o">|</span>     <span class="p">(</span><span class="mi">9</span><span class="p">)</span>      <span class="o">|</span>
       <span class="o">|</span>              <span class="o">+--</span><span class="n">to_inner</span><span class="p">()</span><span class="o">-&gt;|</span>
       <span class="o">|</span>              <span class="o">|</span>     <span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span>

<span class="p">[</span><span class="n">Statechart</span><span class="p">:</span> <span class="mi">2771</span><span class="n">f_ao</span><span class="p">]</span> <span class="p">(</span><span class="n">B</span><span class="p">)</span>
         <span class="n">top</span>                 <span class="n">outer</span>                <span class="n">inner</span>
          <span class="o">+-----</span><span class="n">start_at</span><span class="p">()</span><span class="o">----&gt;|</span>                    <span class="o">|</span>
          <span class="o">|</span>        <span class="p">(</span><span class="mi">2</span><span class="p">)</span>         <span class="o">|</span>                    <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+--</span><span class="n">other_to_inner</span><span class="p">()</span><span class="o">-&gt;|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">4</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+&lt;-</span><span class="n">other_to_outer</span><span class="p">()</span><span class="o">--|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">6</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+-----</span><span class="n">to_inner</span><span class="p">()</span><span class="o">----&gt;|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">8</span><span class="p">)</span>         <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+&lt;-</span><span class="n">other_to_outer</span><span class="p">()</span><span class="o">--|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">10</span><span class="p">)</span>        <span class="o">|</span>
          <span class="o">|</span>                    <span class="o">+--</span><span class="n">other_to_inner</span><span class="p">()</span><span class="o">-&gt;|</span>
          <span class="o">|</span>                    <span class="o">|</span>        <span class="p">(</span><span class="mi">11</span><span class="p">)</span>        <span class="o">|</span>
</pre></div>
</div>
<p>The sequence tool quickly pulls out each statechart’s contribution to
snoop_trace, attributing them to their own sequence diagram.  This is useful if
you are describing some complicated multi-unit feature in your design.</p>
</div>
<div class="section" id="build-a-networkedactiveobject">
<span id="example-build-a-networkedactiveobject"></span><h2>Build a NetworkedActiveObject<a class="headerlink" href="#build-a-networkedactiveobject" title="Permalink to this headline">#</a></h2>
<p>Here I’ll make another version of the NetworkedActiveObject code without a lot
of extra explanation.</p>
<p>Starting with a picture of the statechart what we want to build:</p>
<a class="reference external image-reference" href="_static/miros_rabbitmq_example_1.pdf"><img alt="_images/miros_rabbitmq_example_1.svg" class="align-center" src="_images/miros_rabbitmq_example_1.svg" /></a>
<p>We import the required items:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span> <span class="c1"># to generate a unique name</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">spy_on</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">miros_rabbitmq</span> <span class="kn">import</span> <span class="n">NetworkedActiveObject</span>
</pre></div>
</div>
<p>Then we construct a function that will generate a unique name for our
statechart:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_name</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">post</span>
</pre></div>
</div>
<p>We write the statechart using the flat method required by the ActiveObject.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">outer_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_outer</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">outer_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">outer_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">inner_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">inner_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">inner_other_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">other_to_outer</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_other_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">inner_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">outer</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">outer_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span><span class="p">,</span> <span class="n">chart</span><span class="o">.</span><span class="n">top</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>We would up a NetworkedActiveObject; providing the required network credentials
and topic keys.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span> <span class="o">=</span> <span class="n">NetworkedActiveObject</span><span class="p">(</span><span class="s1">&#39;make_name(&#39;</span><span class="n">ao</span><span class="s1">&#39;),</span>
  <span class="n">rabbit_user</span><span class="o">=</span><span class="s1">&#39;peter&#39;</span><span class="p">,</span>
  <span class="n">rabbit_password</span><span class="o">=</span><span class="s1">&#39;rabbit&#39;</span><span class="p">,</span>
  <span class="n">tx_routing_key</span><span class="o">=</span><span class="s1">&#39;heya.man&#39;</span><span class="p">,</span>
  <span class="n">rx_routing_key</span><span class="o">=</span><span class="s1">&#39;#.man&#39;</span><span class="p">,</span>
  <span class="n">mesh_encryption_key</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;u3Uc-qAi9iiCv3fkBfRUAKrM1gH8w51-nVU8M8A73Jg=&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We enable the level of instrumentation we want (trace) and start the chart and
let it run for 20 seconds:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ao</span><span class="o">.</span><span class="n">enable_snoop_trace</span><span class="p">()</span>  <span class="c1"># we want to produce and receive trace information</span>
<span class="n">ao</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>  <span class="c1"># networks turned on</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>      <span class="c1"># 60 seconds of statechart interactions</span>
</pre></div>
</div>
</div>
<div class="section" id="building-a-networkedfactory">
<span id="example-networkedfactory"></span><h2>Building a NetworkedFactory<a class="headerlink" href="#building-a-networkedfactory" title="Permalink to this headline">#</a></h2>
<p>Let’s build the same chart using an NetworkedFactory:</p>
<a class="reference external image-reference" href="_static/miros_rabbitmq_example_1.pdf"><img alt="_images/miros_rabbitmq_example_1.svg" class="align-center" src="_images/miros_rabbitmq_example_1.svg" /></a>
<p>We import what is needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">miros_rabbitmq.network</span> <span class="kn">import</span> <span class="n">NetworkedFactory</span>
<span class="kn">from</span> <span class="nn">miros.event</span> <span class="kn">import</span> <span class="n">signals</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">return_status</span>
</pre></div>
</div>
<p>Then we write something that will make a unique name for each of our networked
state machines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_name</span><span class="p">(</span><span class="n">post</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">post</span>
</pre></div>
</div>
<p>Studying our diagram we generate the required callback methods for our factory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">on_outer_init</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
    <span class="n">deferred</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_outer</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">on_outer_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_outer_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">inner</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_inner_entry</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">period</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">transmit</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">on_inner_exit</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">chart</span><span class="o">.</span><span class="n">cancel_events</span><span class="p">(</span>
    <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">on_inner_other_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">on_inner_to_inner</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>

<span class="k">def</span> <span class="nf">on_inner_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">on_inner_other_to_outer</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">chart</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
</pre></div>
</div>
<p>We build a NetworkedFactory object with the required networking credentials, the
routing keys we want and an encryption key:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">chart</span> <span class="o">=</span> <span class="n">NetworkedFactory</span><span class="p">(</span><span class="n">make_name</span><span class="p">(</span><span class="s1">&#39;fo&#39;</span><span class="p">),</span>
         <span class="n">rabbit_user</span><span class="o">=</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span>
         <span class="n">rabbit_password</span><span class="o">=</span><span class="s1">&#39;dobbs&#39;</span><span class="p">,</span>
         <span class="n">tx_routing_key</span><span class="o">=</span><span class="s1">&#39;heya.man&#39;</span><span class="p">,</span>
         <span class="n">rx_routing_key</span><span class="o">=</span><span class="s1">&#39;#.man&#39;</span><span class="p">,</span>
         <span class="n">mesh_encryption_key</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;u3Uc-qAi9iiCv3fkBfRUAKrM1gH8w51-nVU8M8A73Jg=&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we use the factory to build up states:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">outer</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_outer_to_inner</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_outer_other_to_inner</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_outer_init</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">to_method</span><span class="p">()</span>

<span class="n">inner</span> <span class="o">=</span> <span class="n">chart</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_inner_entry</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_inner_exit</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_inner</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_inner_other_to_inner</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_inner</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_inner_to_inner</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_outer</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_inner_to_outer</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">catch</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">other_to_outer</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">on_inner_other_to_outer</span><span class="p">)</span><span class="o">.</span> \
          <span class="n">to_method</span><span class="p">()</span>
</pre></div>
</div>
<p>Add the hierarchy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">chart</span><span class="o">.</span><span class="n">nest</span><span class="p">(</span><span class="n">outer</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span> \
      <span class="n">nest</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">outer</span><span class="p">)</span>
</pre></div>
</div>
<p>The we seed our random number generator, enable the instrumentation we want and
start the statechart and let it run for 20 seconds:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
<span class="n">chart</span><span class="o">.</span><span class="n">enable_snoop_trace</span><span class="p">()</span>
<span class="n">chart</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">outer</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


        
        <div class="main-content__right-sidebar">
          <h2 class="sidebar-heading">On this page:</h2>
        </div>
      </div>
    </main>

    <div class="footer-wrapper">
      
      <footer class="main-footer main-footer--sidebar">
      
        <div class="relational-links">
          <div>
            
            ← <a class="relational-link" href="how_it_works.html" title="previous chapter">How it Works</a>
            
          </div>
          <div>
            
             <a class="relational-link" href="recipes.html" title="next chapter">Recipes</a> →
            
          </div>
        </div>
        
        <div class="copyright">
          © Copyright <span class="js-year"></span>,
          
          <a href="https://github.com/aleph2c" class="copyright_link">Scott Volk</a>.
          
        </div>
        
        
        <div class="last-updated">
          <span class="prefix">Last updated:</span>
          <span class="time">Jul 13, 2020 6:13 AM</span>
        </div>
        
        
        <div class="created-with">
          Created using <a href="http://sphinx-doc.org/" class="copyright_link">Sphinx</a> 3.1.2 with <span class="theme">13ds_theme_one</span>.
        </div>
        
      </footer>
    </div>
  </body>
</html>