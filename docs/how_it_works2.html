
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>How it Works (Design Re-write in Progress) &#8212; miros-rabbitmq 2.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example" href="example.html" />
    <link rel="prev" title="How it Works" href="how_it_works.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="how-it-works-design-re-write-in-progress">
<h1>How it Works (Design Re-write in Progress)<a class="headerlink" href="#how-it-works-design-re-write-in-progress" title="Permalink to this headline">¶</a></h1>
<div class="section" id="the-cache-file-chart">
<span id="how-it-works2-the-cache-file-chart"></span><h2>The Cache File Chart<a class="headerlink" href="#the-cache-file-chart" title="Permalink to this headline">¶</a></h2>
<p>The network discovery process is expensive, so we will cache its results to a
JSON file.</p>
<p>The cache will persist beyond the life of the program that wrote it.  When the
next program runs, it will read the cache, determine if it is young enough to be
useful, and if so, it will skip the expensive network discovery process.</p>
<p>We use the JSON format since we will be transmitting this cache to other hosts
and JSON has become the standard format for transmitting data.</p>
<p>But there could be thousands of processes trying to read and write to this cache
file at the same time.  To address this concern, we wrap this file access into
an active object which will check if the file is writable before trying to read
or write from it.  If the file is writable, the statechart will determine that
no other program is using the file.</p>
<a class="reference external image-reference" href="_static/miros_rabbitmq_cache_file_chart.pdf"><div align="center" class="align-center"><img alt="_images/miros_rabbitmq_cache_file_chart.svg" src="_images/miros_rabbitmq_cache_file_chart.svg" /></div>
</a>
<p>The design was intended to be built within another statechart and to start
itself upon being constructed.  The CacheFileChart subscribes to the
<code class="docutils literal"><span class="pre">CACHE_FILE_WRITE</span></code> and the <code class="docutils literal"><span class="pre">CACHE_FILE_READ</span></code> events.  If any other part of the
program wants to see what is in the cache, they would post a <code class="docutils literal"><span class="pre">CACHE_FILE_READ</span></code>.
The CacheFileChart will send a <code class="docutils literal"><span class="pre">CACHE</span></code> event with the contents of the cache and
whether the cache has been expired.</p>
<p>If any other statechart would like to write the cache, they would place the
contents of the write into a dict as the payload of the <code class="docutils literal"><span class="pre">CACHE_FILE_WRITE</span></code>.</p>
<p>Internally the <code class="docutils literal"><span class="pre">CACHE_FILE_READ</span></code> and <code class="docutils literal"><span class="pre">CACHE_FILE_WRITE</span></code> public events are turned
into the <code class="docutils literal"><span class="pre">file_read</span></code> and <code class="docutils literal"><span class="pre">file_write</span></code> events.  When the state chart sees that such
an event is posted it will try to enter the file_read or file_write states.
Such transitions can be blocked if the file is not writable (set by the OS).  In
the case that the event is blocked, the statechart re-posts the same event to
itself at a future time, then stops running.  The re-posting time is a random
number between 0.001 and a timeout.  This timeout parameter increases for each
re-posting failure, to a maximum value of 5 seconds.</p>
<p>If a <code class="docutils literal"><span class="pre">file_read</span></code> or <code class="docutils literal"><span class="pre">file_write</span></code> event succeeds to transition past the file access
state, it will lock the file by making it un-writable.  This global state, put
onto the file by the operating system will make the file exclusive to this
program.  When the file is read or written, the CacheFileChart will post either
a read_successful or write_successful event to itself.  This will cause an exit
signal to occur on the file_accessed state, which will make the file writable.
Other programs will now have the ability to access the same file when their
deferred <code class="docutils literal"><span class="pre">file_read</span></code> or <code class="docutils literal"><span class="pre">file_write</span></code> events fire.</p>
<p>The internal code within the file_read and file_write states was taken from
various stack overflow articles describing how to safely read and write a file
in a very short period of time, in an environment where many other programs are
trying to do the same thing.</p>
</div>
<div class="section" id="the-rabbit-consumer-scout-chart">
<span id="how-it-works2-producescoutchart"></span><h2>The Rabbit Consumer Scout Chart<a class="headerlink" href="#the-rabbit-consumer-scout-chart" title="Permalink to this headline">¶</a></h2>
<p>The RabbitConsumerScoutChart searches an IP address to see if there is a
compatible RabbitMQ consumer running on it.  RabbitConsumerScoutChart was
designed to:</p>
<ul class="simple">
<li>run in parallel with other instances of itself (for parallel searches)</li>
<li>be started within another statechart</li>
<li>be destroyed within another statechart</li>
<li>ensure the RabbitMQ credentials were not in the code base</li>
<li>ensure the encryption secrets where not in the code base</li>
<li>hide the complexity of the pika producer creation process</li>
<li>provide the capability to be run multiple times with different search criterion</li>
<li>be easy to make</li>
</ul>
<p>To perform a scouting mission for a given IP address, routing_key and an
exchange_name you can write something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">scout1</span> <span class="o">=</span> <span class="n">RabbitConsumerScoutChart</span><span class="p">(</span>
  <span class="s1">&#39;192.168.1.77&#39;</span><span class="p">,</span>
  <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;heya.man&#39;</span><span class="p">,</span>
  <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;miros.mesh.exchange&#39;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># to debug the chart</span>
</pre></div>
</div>
<p>The answer will come back in the form of an <code class="docutils literal"><span class="pre">AMQP_CONSUMER_CHECK</span></code> event with a
payload containing a tuple.  The tuple will have an IP address as its first
member and a boolean as it’s second member.  The third and forth members will be
the routing_key and the RabbitMq exchange used in the search.  If the address
has a amqp consumer that can be reached with the credentials provided, the
boolean will be, you guessed it, True, otherwise the second tuple member will be
False.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Other state chart would catch this</span>
<span class="c1"># if the IP has a working consumer:</span>
<span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">AMQP_CONSUMER_CHECK</span><span class="p">,</span>
  <span class="n">payload</span><span class="o">=</span><span class="p">(</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.77</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;heya.man&#39;</span><span class="p">,</span> <span class="s1">&#39;miros.mesh.exchange&#39;</span><span class="p">))</span>

<span class="c1"># Other state chart would catch this</span>
<span class="c1"># if the IP does not have a working consumer:</span>
<span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">AMQP_CONSUMER_CHECK</span><span class="p">,</span>
  <span class="n">payload</span><span class="o">=</span><span class="p">(</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.77</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;heya.man&#39;</span><span class="p">,</span> <span class="s1">&#39;miros.mesh.exchange&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>To perform another search on the same scout, in another statechart you would
post a <code class="docutils literal"><span class="pre">REFACTOR_SEARCH</span></code> event:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">chart</span><span class="o">.</span><span class="n">postfifo</span><span class="p">(</span>
  <span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">REFACTOR_SEARCH</span><span class="p">,</span>
    <span class="n">payload</span><span class="o">=</span><span class="p">{</span>
      <span class="s1">&#39;ip_address&#39;</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.77</span><span class="p">,</span>
      <span class="s1">&#39;routing_key&#39;</span><span class="p">:</span> <span class="s1">&#39;archer.bob&#39;</span>
      <span class="s1">&#39;exchange_name&#39;</span><span class="p">:</span> <span class="s1">&#39;miros.mesh.exchange&#39;</span><span class="p">,</span>
      <span class="p">}</span>
  <span class="p">)</span>
</pre></div>
</div>
<p>Later, assuming this search resulted in a miss, the chart that sent out the
<code class="docutils literal"><span class="pre">REFACTOR_SEARCH</span></code> would receive the following signal:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">AMQP_CONSUMER_CHECK</span><span class="p">,</span>
  <span class="n">payload</span><span class="o">=</span><span class="p">(</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">1.77</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s1">&#39;archer.bob&#39;</span><span class="p">,</span> <span class="s1">&#39;miros.mesh.exchange&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Here is the design diagram from the RabbitConsumerScoutChart, if you can’t see
it, click on it to download a pdf of the diagram:</p>
<a class="reference external image-reference" href="_static/miros_rabbitmq_consumer_scout_chart.pdf"><div align="center" class="align-center"><img alt="_images/miros_rabbitmq_consumer_scout_chart.svg" src="_images/miros_rabbitmq_consumer_scout_chart.svg" /></div>
</a>
<p>The <code class="docutils literal"><span class="pre">RabbitConsumerScout</span></code> class contains the data and methods that are used by
the <code class="docutils literal"><span class="pre">RabbitConsumerScoutChart</span></code>.  The <code class="docutils literal"><span class="pre">RabbitConsumerScout</span></code> class basically
hides the complexity of building a RabbitMQ producer by asking the
<code class="docutils literal"><span class="pre">RabbitTopicPublisherMaker</span></code> object to make the producer for it.  This
<code class="docutils literal"><span class="pre">RabbitTopicPublisherMaker</span></code> object, accesses the hidden credentials from the
<code class="docutils literal"><span class="pre">.env</span></code> file tucked away somewhere in an outer directory.  The diagram tries to
describe how this information is stored in an <code class="docutils literal"><span class="pre">.env</span></code> file, loaded into the
environment then used by the <code class="docutils literal"><span class="pre">RabbitTopidPublisherMaker</span></code> class to build up a
topic publisher.</p>
<p>The <code class="docutils literal"><span class="pre">RabbitConsumerScoutChart</span></code> inherits from the <code class="docutils literal"><span class="pre">RabbitConsumerScout</span></code>
class, so it gets the publisher as part of the deal.  The client basically needs
to provide it an IP address, a routing key and an exchange name and it is ready
to perform a search.  A user can provide the <code class="docutils literal"><span class="pre">live_trace</span></code> and <code class="docutils literal"><span class="pre">live_spy</span></code>
arguments if they need to debug the statechart encase within the
<code class="docutils literal"><span class="pre">RabbitConsumerScoutChart</span></code>, but by default this instrumentation is off.  Let’s
turn this instrumentation on and then describe what it is doing.  We will do
this twice, once for an address that doesn’t have a RabbitMQ server running on
it and a second time with an address that does.</p>
<p>Let’s start with failure:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">scout1</span> <span class="o">=</span> <span class="n">RabbitConsumerScoutChart</span><span class="p">(</span>
  <span class="s1">&#39;192.168.1.77&#39;</span><span class="p">,</span>
  <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;heya.man&#39;</span><span class="p">,</span>
  <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;miros.mesh.exchange&#39;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># to debug the chart</span>
</pre></div>
</div>
<p>This will result in the following trace instrumentation:</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><p class="logo"><a href="index.html">
  <img class="logo_a" src="_static/miros_rabbitmq_icon_only.svg" width="90" alt="Logo" >
</a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How it Works (Design Re-write in Progress)</a><ul>
<li><a class="reference internal" href="#the-cache-file-chart">The Cache File Chart</a></li>
<li><a class="reference internal" href="#the-rabbit-consumer-scout-chart">The Rabbit Consumer Scout Chart</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="how_it_works.html" title="previous chapter">How it Works</a></li>
      <li>Next: <a href="example.html" title="next chapter">Example</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/how_it_works2.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Scott Volk.
      
      |
      <a href="_sources/how_it_works2.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>